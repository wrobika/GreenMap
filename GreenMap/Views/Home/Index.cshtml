@{
    ViewData["Title"] = "Home Page";
}

    <span id="status">&nbsp;0 selected features</span>
@{
    await Html.RenderPartialAsync("_NavigationBar");
    var epionierDbContext = new epionierContext();
    var zielenController = new GreenMap.Controllers.ZielenController(epionierDbContext);
    var greenery = zielenController.GetZielen();
}

<script type="text/javascript">

    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });

    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    proj4.defs('EPSG:2180', '+proj=tmerc + lat_0=0 + lon_0=19 + k=0.9993 + x_0=500000 + y_0=-5300000 + ellps=GRS80 + towgs84=0, 0, 0, 0, 0, 0, 0 + units=m + no_defs');
    ol.proj.proj4.register(proj4);

    var greeneryArray = @Html.Raw(Json.Serialize(greenery.Result));
    var wktReader = new ol.format.WKT();
    var greeneryFeatures = [];
    for (var green of greeneryArray) {
        console.log(green);
        var feature = wktReader.readFeature(green);
        feature.getGeometry().transform('EPSG:2180', 'EPSG:3857');
        greeneryFeatures.push(feature);
    }

    var features = [new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([19.978618, 50.060601])))];

    var greenerySource = new ol.source.Vector({
      features: greeneryFeatures
    });

    var greeneryLayer = new ol.layer.Vector({
        name: 'points',
        source: greenerySource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'Green'
            }),
            fill: new ol.style.Fill({
                color: 'LimeGreen'
            })
        })
    });

    var background = new ol.layer.Tile({
        name: 'background',
        source: new ol.source.OSM()
    });

    var wms = new ol.layer.Tile({
        name: 'wms',
        source: new ol.source.TileWMS({
            url: 'https://ahocevar.com/geoserver/wms',
            params: { 'LAYERS': 'topp:states', 'TILED': true },
        })
    });

    var map = new ol.Map({
        layers: [background, wms, greeneryLayer],
        target: 'map',
        overlays: [overlay],
        view: new ol.View({
            center: ol.proj.fromLonLat([19.978618, 50.060601]),
            zoom: 12
        })
    });

    function changeVisibility() {
        var layer_name = this.value;
        var button = this;
        map.getLayers().forEach(function (layer) {
            console.log(layer.get('name'));
            console.log(layer.get('visible'));
            if (layer.get('name') === layer_name) {
                var isVisible = layer.get('visible');
                layer.setVisible(!isVisible);
                if (isVisible) {
                    button.className = 'dropdown-item text-black bg-light';
                } else {
                    button.className = 'dropdown-item text-white bg-success';
                }
            }
        });
    }

    let buttons = document.querySelectorAll('.dropdown-item')
    buttons.forEach((btn) => {
        btn.addEventListener("click", changeVisibility);
    });

    var wktReader = new ol.format.WKT();
    var interaction = new ol.interaction.Select({
        condition: ol.events.condition.click,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'DarkGreen'
            }),
            fill: new ol.style.Fill({
                color: 'Green'
            })
        })
        //condition: ol.events.condition.pointerMove,
    });
    map.addInteraction(interaction);
    interaction.on('select', function (e) {
        var selectFeatures = interaction.getFeatures().getArray();
        document.getElementById('status').innerHTML = '&nbsp;' +
            e.target.getFeatures().getLength() +
            ' selected features (last operation selected ' + e.selected.length +
            ' and deselected ' + e.deselected.length + ' features)';
        if (selectFeatures.length !== 0) {
                    var coordinate = selectFeatures[0].getGeometry().getCoordinates();
        var hdms = ol.coordinate.toStringHDMS(ol.proj.toLonLat(coordinate));
        content.innerHTML = '<p>You clicked here:</p><code>' + hdms +'</code>';
        overlay.setPosition(coordinate);
        } else {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        }

        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "POST",
            url: "/grid",
            data: wktReader.writeFeatures(selectFeatures, { dataProjection: 'EPSG:4326', featureProjection: 'EPSG:3857' }),
            success: function (data) {

            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log('error while post');
            }
        });
    });

    map.on('singleclick', function(evt) {
        var coordinate = evt.coordinate;
        var hdms = ol.coordinate.toStringHDMS(ol.proj.toLonLat(coordinate));

        content.innerHTML = '<p>You clicked here:</p><code>' + hdms +
            '</code>';
        overlay.setPosition(coordinate);
    });
</script>